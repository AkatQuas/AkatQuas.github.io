"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[1395],{3905:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},h=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,h=c(e,["components","mdxType","originalType","parentName"]),p=l(n),d=r,k=p["".concat(s,".").concat(d)]||p[d]||u[d]||o;return n?a.createElement(k,i(i({ref:t},h),{},{components:n})):a.createElement(k,i({ref:t},h))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c[p]="string"==typeof e?e:r,i[1]=c;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},93949:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const o={title:"Health checks",sidebar_position:6},i=void 0,c={unversionedId:"docker/health-checks",id:"docker/health-checks",title:"Health checks",description:"Health Checks",source:"@site/docs/docker/health-checks.md",sourceDirName:"docker",slug:"/docker/health-checks",permalink:"/docs/docker/health-checks",draft:!1,tags:[],version:"current",sidebarPosition:6,frontMatter:{title:"Health checks",sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"Docker Compose",permalink:"/docs/docker/docker-compose"},next:{title:"Container monitoring",permalink:"/docs/docker/container-monitoring"}},s={},l=[{value:"Health Checks",id:"health-checks",level:2},{value:"Starting containers with dependency checks",id:"starting-containers-with-dependency-checks",level:3},{value:"Defining health checks and dependency checks in Docker Compose",id:"defining-health-checks-and-dependency-checks-in-docker-compose",level:2},{value:"Understanding how checks power self-healing apps",id:"understanding-how-checks-power-self-healing-apps",level:2},{value:"API Reference",id:"api-reference",level:2}],h={toc:l};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"health-checks"},"Health Checks"),(0,r.kt)("p",null,"Docker monitors the health of your app at a basic level every time you run a container."),(0,r.kt)("p",null,"Containers run a specific process when they start, which could be the Java or .NET Core runtime, a shell script, or an application binary. Docker checks that the process is still running, and if it stops, the container goes into the exited state."),(0,r.kt)("p",null,"That gives you a basic health check that works across all environments. Developers can see that their app is unhealthy if the process fails and the container exits."),(0,r.kt)("p",null,"In a clustered environment, the container platform can restart an exited container or create a replacement container. However, this kind of restarting has nothing todo with container's health."),(0,r.kt)("p",null,"Docker gives you a neat way to build a real application health check right into the Docker image, just by adding logic to the Dockerfile."),(0,r.kt)("p",null,"Enter the ",(0,r.kt)("inlineCode",{parentName:"p"},"HEALTHCHECK")," instruction, which you can add to a Dockerfile to tell the runtime exactly how to check whether the app in the container is still healthy. The ",(0,r.kt)("inlineCode",{parentName:"p"},"HEALTHCHECK")," instruction specifies a command for Docker to run inside the container, which will return a status code -- the command can be anything you need to check if your app is healthy. Docker will run that command in the container at a timed interval. If the status code says everything is good, then the container is healthy. If the status code is a failure several times in a row, then the container is marked as unhealthy."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'HEALTHCHECK CMD curl --fail http://localhost/health\n\nHEALTHCHECK CMD ["<execute-binary>", "<execute-file>", "<options>", "http://localhost/health"]\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Use ",(0,r.kt)("inlineCode",{parentName:"p"},"docker inspect <container>")," to check the ",(0,r.kt)("inlineCode",{parentName:"p"},"Health")," field, which indicates the health status of the container.")),(0,r.kt)("p",null,"Would Docker restart or replace the container that is unhealthy? -> The Docker does nothing with it, Docker broadcasts that the container is unhealthy but leaves it as it is. But keep it in mind, the health check continues too, so if the failure is temporary and the next check passes, the container status flips to healthy again."),(0,r.kt)("p",null,"Health checks become really useful in a cluster with multiple servers running Docker being managed by Docker Swarm or Kubernetes. Then the container platform is notified if the container is unhealthy and it can take action. Because there is additional capacity in a cluster, a replacement container can be started while the unhealthy one is still running, so there shouldn't be any application downtime."),(0,r.kt)("h3",{id:"starting-containers-with-dependency-checks"},"Starting containers with dependency checks"),(0,r.kt)("p",null,"Running across a cluster brings new challenges for distributed apps, because you can no longer control the ",(0,r.kt)("em",{parentName:"p"},"startup order")," for containers that may have dependencies on each other."),(0,r.kt)("p",null,"Some apps may have logic built into them to verify that the dependencies they need are there when they start."),(0,r.kt)("p",null,"You can add that dependency check inside the Docker image. A dependency check is different from a health check -- it runs before the application starts and makes sure everything the app needs is available."),(0,r.kt)("p",null,"Docker doesn't have a built-in feature like the ",(0,r.kt)("inlineCode",{parentName:"p"},"HEALTHCHECK")," instruction for dependency checks, but you can put that logic in the startup command."),(0,r.kt)("p",null,"Any extra tools increase the image size, and they also increase the frequency of updates and the security attack surface. So although curl is a great tool for getting started with container checks, it\u2019s better to write a custom utility for your checks using the same language that your application uses\u2014Java for Java apps, Node.js for Node.js apps, and so on."),(0,r.kt)("p",null,"There are a whole lot of advantages to this:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"You reduce the software requirements in your image -- you don't need to install any extra tools, because everything the check utility needs to run is already there for the application.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"You can use more complex conditional logic in your checks with retries or branches, which are harder to express in shell scripts, especially if you\u2019re publishing cross-platform Docker images for Linux and Windows.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Your utility can use the same application configuration that your app uses, so you don't end up specifying settings like URLs in several places, with the risk of them getting out of sync.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"You can execute any tests you need, checking database connections or file paths for the existence of certificates that you\u2019re expecting the platform to load into the container -- all using the same libraries your app uses."))),(0,r.kt)("h2",{id:"defining-health-checks-and-dependency-checks-in-docker-compose"},"Defining health checks and dependency checks in Docker Compose"),(0,r.kt)("p",null,"Docker Compose can go some way toward repairing unreliable applications, but it won't replace unhealthy containers. But it can set containers to restart if they exit, and it can add a health check if there isn't one already in the image."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"# There's no `depends_on` setting, Docker Compose\n# could start the containers in any order\nversion: '3.7'\n\nservices:\n  numbers-api:\n    image: numbers-api\n    ports:\n      - '8087:80'\n    healthcheck: # run the `HEALTHCHECK` command in that container\n      interval: 5s # interval between checks\n      timeout: 1s # timeout is limited for a single healthcheck\n      retries: 2 # maximum failures before the container to be flagged as unhealthy\n      start_period: 5s # time to wait before the first health checks\n    networks:\n      - app-net\n\n  numbers-web:\n    image: numbers-web\n    restart: on-failure # restart container if exit\n    environment:\n      - RngApi__Url=http://numbers-api/rng\n    ports:\n      - '8088:80'\n    healthcheck:\n      # using the given command, which is not exist in the container Dockerfile\n      test: ['CMD', '<execute-cmd>', '<execute-file>', '-option', '']\n      interval: 5s\n      timeout: 1s\n      retries: 2\n      start_period: 10s\n    networks:\n      - app-net\n\nnetworks:\n  app-net:\n    external:\n      name: nat\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Why bother building a dependency check into the container startup when Docker Compose can do it for you with the ",(0,r.kt)("inlineCode",{parentName:"p"},"depends_on")," flag? The answer is that Compose can only manage dependencies on a single machine, and the startup behavior of your app on a production cluster is far less predictable.")),(0,r.kt)("h2",{id:"understanding-how-checks-power-self-healing-apps"},"Understanding how checks power self-healing apps"),(0,r.kt)("p",null,"With dependency checks and health checks, we don't require the platform to guarantee the startup order -- the platform could spin up as many as containers on as many servers as quickly as it could. If some of those containers can't reach their dependencies, they fail quickly and get restarted or replaced with other containers."),(0,r.kt)("p",null,"The idea of self-healing apps is that any transient failures can be dealt with by the platform. If your app has a nasty bug that causes it to run out of memory, the platform will shut down the container and replace it with a new one that has a fresh allocation of memory. It doesn't fix the bug, but it keeps the app working correctly."),(0,r.kt)("p",null,"You do need to be careful with your checks though. Health checks run periodically, so they shouldn't do too much work. You need to find the balance so checks are testing that key parts of your app are working without taking too long to run or using too much compute resource. Dependency checks only run at startup, so you don't need to be too concerned about the resources they use, but you need to be careful what you check. Some dependencies are out of your control, and if the platform can't fix things, it won't be helpful if your containers fail."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"During the startup life cycle, if the container starts and then exists because its dependencies are not available. The platform will try to ",(0,r.kt)("em",{parentName:"p"},"restarts the container until it starts correctly")," with its successful dependency checks.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"During the ongoing app life cycle. At some point the app fails, and the health checks fail repeatedly, so the container is flagged as unhealthy. The platform ",(0,r.kt)("em",{parentName:"p"},"creates a replacement container")," (maybe on another server) and when that is running correctly, the original unhealthy container is shut down."))),(0,r.kt)("h2",{id:"api-reference"},"API Reference"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/builder/#healthcheck"},"HEALTHCHECK")))}p.isMDXComponent=!0}}]);