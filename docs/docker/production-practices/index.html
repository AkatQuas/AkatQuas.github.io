<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-docker/production-practices">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Production Practices | AkatQuas&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://akatquas.github.io/docs/docker/production-practices"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Production Practices | AkatQuas&#x27;s blog"><meta data-rh="true" name="description" content="Optimizing the image"><meta data-rh="true" property="og:description" content="Optimizing the image"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://akatquas.github.io/docs/docker/production-practices"><link data-rh="true" rel="alternate" href="https://akatquas.github.io/docs/docker/production-practices" hreflang="en"><link data-rh="true" rel="alternate" href="https://akatquas.github.io/docs/docker/production-practices" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="AkatQuas&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="AkatQuas&#39;s blog Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d30c7ca7.css">
<link rel="preload" href="/assets/js/runtime~main.5d758bff.js" as="script">
<link rel="preload" href="/assets/js/main.6f4b5c91.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="AkatQuas" class="themedImage_ToTc themedImage--light_HNdA"><img src="/images/logo.svg" alt="AkatQuas" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">AkatQuas ðŸ”­</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/about">Topic</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://akatquas.github.io/dateless/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Dateless<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/AkatQuas/AkatQuas.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/about">Akat</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/network-top-down-approach/">Computer Network</a><button aria-label="Toggle the collapsible sidebar category &#x27;Computer Network&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/data-structure/">Data Structure</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data Structure&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/compiler/">Compiler</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compiler&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/interpreter-in-js/">Writing a interpreter in JavaScript</a><button aria-label="Toggle the collapsible sidebar category &#x27;Writing a interpreter in JavaScript&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/lisp-interpreter-in-c/index">Build Your Own Lisp Interpreter in C</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/lisp-interpreter-in-py/chapter-00">Build A Lisp Interpreter in Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/sicp/index">SICP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/concurrency-in-go/">Concurrency in Go</a><button aria-label="Toggle the collapsible sidebar category &#x27;Concurrency in Go&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/docker/">Docker</a><button aria-label="Toggle the collapsible sidebar category &#x27;Docker&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/">Learn some Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/persistent-storage">Persistent storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/networking">Docker Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/docker-compose">Docker Compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/health-checks">Health checks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/container-monitoring">Container monitoring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/automation">Automation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/orchestration">Orchestration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/remote-engine">Remote access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/security">Security in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/docker/production-practices">Production Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docker/cheatsheet">Cheatsheet</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/kubernetes/">Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/docker/"><span itemprop="name">Docker</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Production Practices</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Production Practices</h1></header><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizing-the-image">Optimizing the image<a class="hash-link" href="#optimizing-the-image" title="Direct link to heading">â€‹</a></h2><p>TL;DR</p><ul><li>Choose the right base image, ideally curate your own set of golden images.</li><li>Use multi-stage Dockerfiles for all but the simplest apps.</li><li>Don&#x27;t add any unnecessary packages or files, focus on layer size.</li><li>Sort your Dockerfile instructions by change frequency, maximize the cache.</li></ul></summary><div><div class="collapsibleContent_i85q"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># show used disk space</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> system </span><span class="token function" style="color:rgb(130, 170, 255)">df</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>It&#x27;s a good habit to run <code>docker system prune</code> regularly -- it clears out image layers and the build cache without removing full images.</p></blockquote><p><strong>Do not include/copy files in the image unless they are required</strong>.</p><p>You could use the <code>.dockerignore</code> file to exclude them from the build context.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM diamol/base</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CMD echo app- &amp;&amp; ls app &amp;&amp; echo docs- &amp;&amp; ls docs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># this `rm -rf` doesn&#x27;t remove the files in `COPY` layer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># the file still exist in `COPY` layer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN rm -rf docs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Each instruction in a Dockerfile produces an image layer, and layers are merged together to form the whole image. If you write files in a layer, those files are permanently there; if you delete them in a subsequent layer, all Docker does is hide them in the filesystem.</p></blockquote><p><strong>Choose the right base images.</strong></p><p>Base image size choice is as much about security as it is about disk space and network transfer time.</p><blockquote><p>If your OS base image has curl installed, an attacker could use that to download malware or upload your data to their servers, if they manage to break out of your app into the container.</p></blockquote><p>Size isn&#x27;t just about disk space -- itâ€™s also about whatâ€™s using the space.</p><blockquote><p>The largest OpenJDK images include the whole Java SDK, so thereâ€™s a nice attack vector there if someone manages to compromise your container. They could write some Java source code files into the containerâ€™s disk, compile them with the SDK, and run an app that does anything they want in the security context of your application container.</p></blockquote><p>You have a team that chooses the right base images and builds their own versions for your organization, which is called the <em>Golden images</em>.</p><p>Another advantage of building your own golden image is that you can integrate additional security checks on the base layer in the build process, using a third-party tool like Anchore.</p><p><strong>Minimizing image layer count and layer size</strong></p><p>Many processes for installing software leave residues behind because they cache package lists or deploy extra recommend packages. You can remove some cache files after installation.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM debian:stretch-slim</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get install -y curl=7.52.1-5+deb9u9</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get install -y socat=1.7.3.1-2+deb9u1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Dockerfile.v2 - optimizing the install steps:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM debian:stretch-slim</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get update \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &amp;&amp; apt-get install -y --no-install-recommends \ curl=7.52.1-5+deb9u9 \ socat=1.7.3.1-2+deb9u1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Another advantage of combining multiple steps in a single <code>RUN</code> instruction is that it produces a single image layer.</p><p>Having fewer layers does make it much easier to keep track of your filesystem.</p><p>Multi-stage Dockerfiles should be a best practice for all, but the simplest images, because they make it far easier to optimize the final image.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM diamol/base AS download</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ARG DATASET_URL=https://archive.ics.uci.edu/ml/machine-learning-databases/url/url_svmlight.tar.gz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN wget -O dataset.tar.gz ${DATASET_URL}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM diamol/base AS expand</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=download dataset.tar.gz .</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN tar xvzf dataset.tar.gz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM diamol/base</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /dataset/url_svmlight</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=expand url_svmlight/Day1.svm .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Itâ€™s clear in each stage what youâ€™re doing, and you don&#x27;t need to dive into unusual command optimizations to save disk space, because the final image will only have the files explicitly copied in from earlier stages.</p><p>One final advantage of multi-stage builds really brings it home: every stage has its own build cache. If you need to tweak the expand stage, when you run the build, the download stage will still come from the cache. Maximizing the build cache is the final part of optimization, and this is all about the speed of building the image.</p><p>The basic way to make the most of the build cache is to order the instructions in your Dockerfile, so the things that change least frequently are at the start, and the things that change most frequently are toward the end.</p></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><h2 class="anchor anchorWithStickyNavbar_LWe7" id="application-configuration-management-in-containers">Application configuration management in containers<a class="hash-link" href="#application-configuration-management-in-containers" title="Direct link to heading">â€‹</a></h2><p>Applications need to load their configuration from the environment theyâ€™re running in, which is usually a combination of environment variables and files read from disk.</p><p>Docker creates that environment for apps running in containers, and it can set environment variables and construct a filesystem from many different sources.</p></summary><div><div class="collapsibleContent_i85q"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-multi-tiered-approach-to-app-configuration">A multi-tiered approach to app configuration<a class="hash-link" href="#a-multi-tiered-approach-to-app-configuration" title="Direct link to heading">â€‹</a></h3><p>The configuration model should reflect the structure of the data, which is typically one of three types:</p><ul><li>Release-level settings, which are the same for every environment for a given release</li><li>Environment-level settings, which are different for every environment</li><li>Feature-level settings, which can be used to change behavior between releases</li></ul><p>Loading config overrides from a known path in your app code lets you provide them from any source into the container.</p><p>Mount different config directory to provide environment-based configuration.</p><p>Thereâ€™s one nuance to this pattern -- your config target can either be a specific file path or a directory. A directory target is more flexible, but the source file names need to match the config file names the app expects.</p><p>The configuration can also load settings from environment variables, and they override any settings loaded from the file hierarchy.</p><blockquote><p>This is the configuration approach recommended in <a href="https://12factor.net" target="_blank" rel="noopener noreferrer">The Twelve-Factor App</a> -- a modern style of application architecture, where <em>environment variables always take precedence over other config sources</em>.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="packaging-config-for-every-environment">Packaging config for every environment<a class="hash-link" href="#packaging-config-for-every-environment" title="Direct link to heading">â€‹</a></h3><p>Many application frameworks support a config management system where you bundle all the config files for every environment in your deployment, and at runtime you set a single value to specify the name of the environment youâ€™re running in. The app platform loads the config file with the matching environment name, and your app is fully configured.</p><ul><li>config.json</li><li>config.{ENV}.json</li><li><em>Environment variables</em></li></ul><p>This is kind of dangerous because all the config settings are included in the image. Be careful when using this approach.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="loading-configuration-from-the-runtime">Loading configuration from the runtime<a class="hash-link" href="#loading-configuration-from-the-runtime" title="Direct link to heading">â€‹</a></h3><p>You add the module to your package list, and in your application code you specify the paths to the config directories and whether you want environment variables brought in to override the config files.</p><ul><li><p>Files are loaded from the config directory first which is populated in the Docker image.</p></li><li><p>Environment-specific files are loaded from the config-override directory, which is empty in the image and can be the target for a container filesystem mount.</p></li><li><p>Environment variables override the file settings.</p></li></ul><p>A config API is a very useful feature in your app when you have multiple layers of config sources; it makes debugging configuration issues much easier, but you need to secure that data:</p><ul><li>Don&#x27;t just publish the whole config; be selective and never include secrets;</li><li>Secure the endpoint so only authorized users can access it;</li><li>Make the config API a feature that can be enabled through config;</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-legacy-apps-in-the-same-way-as-new-apps">Configuring legacy apps in the same way as new apps<a class="hash-link" href="#configuring-legacy-apps-in-the-same-way-as-new-apps" title="Direct link to heading">â€‹</a></h3><p>Legacy apps have their own ideas about configuration, which don&#x27;t usually involve environment variables or file merges.</p><p>The approach here is to package a utility app or set of scripts that transform the configuration settings in the container environment into the configuration model the application expects. The exact implementation will depend on your app framework and how it uses config files, but the logic will be something like this:</p><ol><li>Read in the config override settings from a specified source file in the container.</li><li>Read in the overrides from environment variables.</li><li>Merge the two sets of overrides, so environment variables take precedence.</li><li>Write the merged overrides to the specified target file in the container.</li></ol><p>In practice youâ€™ll use the release-level settings built into the container image, with the environment-level override file provided by the container platform in almost all cases, but the ability to set feature-level config with environment variables is a useful addition. It means you can react quickly to production issuesâ€”tuning down the level of logging if thatâ€™s a performance issue, or turning off a feature that has a security hole. It also means you can create a production-like environment on a dev machine to replicate a bug, using the production config override with secrets removed, and using environment variables instead.</p></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><h2 class="anchor anchorWithStickyNavbar_LWe7" id="writing-and-managing-application-logs">Writing and managing application logs<a class="hash-link" href="#writing-and-managing-application-logs" title="Direct link to heading">â€‹</a></h2><p>The basic principle is simple: you need to make sure your application logs are being written to the standard output stream, because thatâ€™s where Docker looks for them.</p><p>Docker has a pluggable logging framework: you need to make sure your application logs are coming out from the container, and then Docker can send them to different places. That lets you build a powerful logging model, where the application logs from all your containers are sent to a central log store with a searchable UI on top of it -- all using open source components, all running in containers.</p></summary><div><div class="collapsibleContent_i85q"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stderr-and-stdout">stderr and stdout<a class="hash-link" href="#stderr-and-stdout" title="Direct link to heading">â€‹</a></h3><p>In a container, Docker watches stdout and stderr and collects the output from the streams, which is the source of the container logs.</p><p>Docker starts a process inside the container and collects the output streams from that process as logs. Docker treats both stdout and stderr in the same way.</p><p>Container logs are stored as <em>JSON files</em>, so the log entries remain available for detached containers which don&#x27;t have a terminal session, and for containers that have exited so there is no application process. Docker manages the JSON files for you and they have the same life cycle as the container, which means when the container is removed, the log files are removed too.</p><p>The format is very simple; it contains a JSON object for each log entry with the string containing the log, the name of the stream where the log came from (stdout or stderr), and a timestamp.</p><p>Docker creates a single JSON log file for each container by default, and will let it grow to any size (until it fills up your disk). You can configure Docker to use rolling files instead, with a maximum size limit, so that when the log file fills up, Docker starts writing to a new file. You also configure how many log files to use, and when theyâ€™re all full, Docker starts overwriting the first file.</p><p>You can set those options at the Docker Engine level so the changes apply to every container, or you can set them for individual containers.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> container run -d --name timecheck2 --log-opt max-size</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">5k --log-opt max-file</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> IMAGE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="replaying-logs-from-other-sinks-to-stdout">Replaying logs from other sinks to stdout<a class="hash-link" href="#replaying-logs-from-other-sinks-to-stdout" title="Direct link to heading">â€‹</a></h3><p>Some applications run in the background, so the container startup process isn&#x27;t actually the application process. Other apps might use an existing logging framework that writes to log files or other locations (called <em>sinks</em> in the logging world).</p><p>Either way, there are no application logs coming from the container start process, so Docker doesn&#x27;t see any logs.</p><p>The pattern for dealing with apps like this is to run a second process in the container startup command, which reads the log entries from the sink that the application uses and writes them to stdout.</p><blockquote><p>This is not a perfect solution. Your utility process is running in the foreground, so it needs to be robust because if it fails, your container exits, even if the actual application is still working in the background. And the reverse is true: if the application fails, but the log relay keeps running, your container stays up even though the app is no longer working. You need health checks in your image to prevent that from happening. And lastly, this is not an efficient use of disk, especially if your app writes a lot of logsâ€”theyâ€™ll be filling up a file in the container filesystem and filling up a JSON file on the Docker host machine.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="collecting-and-forwarding-container-logs">Collecting and forwarding container logs<a class="hash-link" href="#collecting-and-forwarding-container-logs" title="Direct link to heading">â€‹</a></h3><p>Docker adds a consistent management layer over all your apps, which is especially useful with logs when you bring a consolidated logging system into your architecture.</p><p>Fluented is a unified logging layer. It can ingest logs from lots of different sources, filter or enrich the log entries, and then forward them on to lots of different targets.</p><p>Fluentd uses a config file to process logs. Run a container with a simple configuration that will have Fluentd collect logs and echo them to stdout in the container.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># run Fluentd publishing the standard port and using a config file:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> container run -d -p </span><span class="token number" style="color:rgb(247, 140, 108)">24224</span><span class="token plain">:24224 --name fluentd -v </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable builtin class-name" style="color:rgb(255, 203, 107)">pwd</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">/conf:/fluentd/etc&quot;</span><span class="token plain"> -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">FLUENTD_CONF</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">stdout.conf fluentd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># now run some container set to use Docker&#x27;s Fluentd log driver:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> container run -d --log-driver</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">fluentd IMAGE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fluentd adds its own metadata to each record when it stores logs, including the container ID and name.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><p>You can run Fluentd to collect all the logs, Elasticsearch in a container for log storage and the companion app Kibana, which is a search UI, in another container.</p></summary><div><div class="collapsibleContent_i85q"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># docker-compose</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;3.7&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># log collector, forwarder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">fluentd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fluentd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">FLUENTD_CONF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> elasticsearch.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./conf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/fluentd/etc</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;24224:24224&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;24224:24224/udp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># log saver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">elasticsearch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> elasticsearch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;9200:9200&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># GUI for log search</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">kibana</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> kibana</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;5601:5601&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># this container produce logs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">accesslog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> access</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">logging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">driver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;fluentd&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">tag</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;app.access-log.{{.ImageName}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># elasticsearch.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># fluentd/conf/fluent.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;source&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  @type forward</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  port 24224</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bind 0.0.0.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/source&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;match *.**&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  @type copy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;store&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @type elasticsearch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    host elasticsearch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    port 9200</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    logstash_format true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    logstash_prefix fluentd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    logstash_dateformat %Y%m%d</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    include_tag_key true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    type_name access_log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tag_key @log_name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    flush_interval 1s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/store&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;store&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @type stdout</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/store&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><h3 class="anchor anchorWithStickyNavbar_LWe7" id="managing-the-log-output-and-collection">Managing the log output and collection<a class="hash-link" href="#managing-the-log-output-and-collection" title="Direct link to heading">â€‹</a></h3><p>Logging is a delicate balance between capturing enough information to be useful in diagnosing problems and not storing huge quantities of data.</p><p>Dockerâ€™s logging model gives you some additional flexibility to help with the balance, because you can produce container logs at a more verbose level than you expect to use, but filter them out before you store them.</p><p>Then if you need to see more verbose logs, you can alter the filter configuration rather than your app configuration so the Fluentd containers get replaced rather than your app containers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-container-logging-model">The Container logging model<a class="hash-link" href="#the-container-logging-model" title="Direct link to heading">â€‹</a></h3><p><strong>EFK</strong>: Elasticsearch, Fluentd, Kibana</p><ul><li><p>A Fluentd container runs on every node in the cluster. Application containers always send logs to the local Fluentd instance on the same node.</p></li><li><p>Elasticsearch is clustered, and the containers/replicas could run any node. The Fluentd containers send log records to the cluster.</p></li><li><p>Kibana reads from the Elasticsearch cluster, give us GUI display.</p></li></ul></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><h2 class="anchor anchorWithStickyNavbar_LWe7" id="controlling-http-traffic-with-a-reverse-proxy">Controlling HTTP traffic with a reverse proxy<a class="hash-link" href="#controlling-http-traffic-with-a-reverse-proxy" title="Direct link to heading">â€‹</a></h2><p>Docker takes care of routing external traffic into your containers, but you can only have one container listening on a network port.</p><p>Thatâ€™s where a <em>reverse proxy</em> comes in.</p></summary><div><div class="collapsibleContent_i85q"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reverse-proxy">Reverse proxy<a class="hash-link" href="#reverse-proxy" title="Direct link to heading">â€‹</a></h3><p>A proxy is a network component that handles network traffic on behalf of some other component. You might have a proxy in your corporate network that:</p><ul><li>intercepts your browser requests and decides whether youâ€™re allowed to access certain sites,</li><li>logs all your activity,</li><li>and caches the responses so other users of the same site get a faster experience.</li></ul><p>You run a reverse proxy as the gateway to several web applications; all traffic goes to the reverse proxy, and it decides which app to get the content from.</p><p>A reverse proxy is the only container with published ports -- it receives all incoming request and fetches the responses from other containers. That means all your application containers become internal components, which can make it easier to scale, update, and secure them.</p><p>You can routing to services using Nginx without Docker Swarm or Kubernetes.</p><p>Nginx can work as a caching proxy, so when it fetches content from your application (called the <em>upstream</em>), it stores a copy in its local disk or memory store.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-native-reverse-proxy">cloud-native reverse proxy<a class="hash-link" href="#cloud-native-reverse-proxy" title="Direct link to heading">â€‹</a></h3><p>Traefik.</p><p>Thereâ€™s no static configuration file for each app you want to make available in the proxy; instead, you add labels to your containers, and Traefik uses those labels to build its own configuration and routing maps.</p><p>Dynamic configuration is one of the major benefits of a container-aware proxy like Traefik. You don&#x27;t need to start your upstream apps before you run Traefik because it watches for new containers while itâ€™s running. You don&#x27;t have to restart Traefik or reload configuration to make a change to your application setupâ€”thatâ€™s all part of your application deployment.</p><p>Traefik has its own API and web UI that shows the rules, so you can run Traefik without any other containers and then deploy an application and see how the config gets built.</p><p>How Traefik works:</p><ul><li><p><strong>Entrypoints</strong>: These are the ports Traefik listens on for external traffic, so these map to the published ports for the container.</p></li><li><p><strong>Routers</strong>: These are the rules for matching an incoming request to a target container. HTTP routers have rules like host name and path to identify client requests.</p></li><li><p><strong>Services</strong>: These are the upstream components -- the application containers that actually serve the content to Traefik so it can pass the response back to the client.</p></li><li><p><strong>Middlewares</strong>: These are components that can modify requests from a router before they get sent to the service. You can use middleware components to change the request path or headers, or even to enforce authentication.</p></li></ul><p>Applying some labels on the container to enable Traefik.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">upservice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.enable=true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.routers.upservice.rule=Host(`upservice.ip`)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">iotd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.enable=true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.routers.image-gallery-api.rule=(Host(`iotd.local`) &amp;&amp; PathPrefix(`/api`))&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.middlewares.image-gallery-api-stripprefix.stripprefix.prefixes=/api,/api/&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.routers.image-gallery-api.middlewares=image-gallery-api-stripprefix@docker&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">image-gallery</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.enable=true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.routers.image-gallery.rule=Host(`image-gallery.local`)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;traefik.http.services.image-gallery.loadbalancer.server.port=80&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Traefik supports some very sophisticated routing options. You can match by host name and path, or a path prefix, and then use a middleware component to strip prefixes.</p><p>Routing, load-balancing, and SSL termination are the main features of a reverse proxy, and Traefik supports them all with dynamic configurations through container labels.</p><p>There&#x27;s a sticky session, which you can enable in Traefik with a setting for the service. With sticky sessions enabled, your requests get served by the same container each time because Traefik sets a cookie identifying which container it should use for that client.</p></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><h2 class="anchor anchorWithStickyNavbar_LWe7" id="asynchronous-communication-with-message-queue">Asynchronous communication with message queue<a class="hash-link" href="#asynchronous-communication-with-message-queue" title="Direct link to heading">â€‹</a></h2><p>Asynchronous communication adds a layer between the client and the server.</p><p>If the client needs a server to do something, it sends a message to the queue. The server is listening on the queue, picks up the message, and processes it. The server can send a response message to the queue, and if the client wants a response, it will be listening on the queue and will pick it up.</p><p>Running queues in lightweight containers means you can run a dedicated queue for each application, and free open source software means you can use the same technology in every environment.</p><p>Redis is a popular message queue option, and you can easily try it out to get a feel for asynchronous messages.</p><p>Queues usually have their own custom communication protocol, which is highly optimized, so when the client sends a message, it just transmits the bytes of the request and waits for an acknowledgement that it has been received. Queues don&#x27;t do any complex processing on the message, so they should easily handle thousands of messages per second.</p><p>The component sending messages is the <em>publisher</em>, and the component receiving messages is the <em>subscriber</em>.</p><p>There could be lots of different systems using the queue, so Redis uses <em>channels</em> to keep messages separate.</p><p>NATS is an alternative message queue; itâ€™s very lightweight and has an admin API.</p><p>Every message in NATS has a subject, which is a string used to identify the type of the message.</p><p>Subscribers will be able to for messages with that subject if theyâ€™re interested in new-item events, but even if there are no subscribers, the app will still publish messages.</p></summary><div><div class="collapsibleContent_i85q"></div></div></details></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/docker/security"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Security in Docker</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/docker/cheatsheet"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cheatsheet</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#optimizing-the-image" class="table-of-contents__link toc-highlight">Optimizing the image</a></li><li><a href="#application-configuration-management-in-containers" class="table-of-contents__link toc-highlight">Application configuration management in containers</a><ul><li><a href="#a-multi-tiered-approach-to-app-configuration" class="table-of-contents__link toc-highlight">A multi-tiered approach to app configuration</a></li><li><a href="#packaging-config-for-every-environment" class="table-of-contents__link toc-highlight">Packaging config for every environment</a></li><li><a href="#loading-configuration-from-the-runtime" class="table-of-contents__link toc-highlight">Loading configuration from the runtime</a></li><li><a href="#configuring-legacy-apps-in-the-same-way-as-new-apps" class="table-of-contents__link toc-highlight">Configuring legacy apps in the same way as new apps</a></li></ul></li><li><a href="#writing-and-managing-application-logs" class="table-of-contents__link toc-highlight">Writing and managing application logs</a><ul><li><a href="#stderr-and-stdout" class="table-of-contents__link toc-highlight">stderr and stdout</a></li><li><a href="#replaying-logs-from-other-sinks-to-stdout" class="table-of-contents__link toc-highlight">Replaying logs from other sinks to stdout</a></li><li><a href="#collecting-and-forwarding-container-logs" class="table-of-contents__link toc-highlight">Collecting and forwarding container logs</a></li><li><a href="#managing-the-log-output-and-collection" class="table-of-contents__link toc-highlight">Managing the log output and collection</a></li><li><a href="#the-container-logging-model" class="table-of-contents__link toc-highlight">The Container logging model</a></li></ul></li><li><a href="#controlling-http-traffic-with-a-reverse-proxy" class="table-of-contents__link toc-highlight">Controlling HTTP traffic with a reverse proxy</a><ul><li><a href="#reverse-proxy" class="table-of-contents__link toc-highlight">Reverse proxy</a></li><li><a href="#cloud-native-reverse-proxy" class="table-of-contents__link toc-highlight">cloud-native reverse proxy</a></li></ul></li><li><a href="#asynchronous-communication-with-message-queue" class="table-of-contents__link toc-highlight">Asynchronous communication with message queue</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas/kiddo-plays" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kiddo plays<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/AkatQuas/nprogresse" target="_blank" rel="noopener noreferrer" class="footer__link-item">NProgressE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas" target="_blank" rel="noopener noreferrer" class="footer__link-item">Who would it be?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 AkatQuas. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5d758bff.js"></script>
<script src="/assets/js/main.6f4b5c91.js"></script>
</body>
</html>