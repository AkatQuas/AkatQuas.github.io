<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Super tiny interpreter in JavaScript | AkatQuas&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://akatquas.github.io/blog/2018/08/23/super-tiny-interpreter"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Super tiny interpreter in JavaScript | AkatQuas&#x27;s blog"><meta data-rh="true" name="description" content="Today we&#x27;re going to write a compiler together. But not just any compiler... A super duper teeny tiny compiler!"><meta data-rh="true" property="og:description" content="Today we&#x27;re going to write a compiler together. But not just any compiler... A super duper teeny tiny compiler!"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2018-08-23T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="javascript,interpreter"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://akatquas.github.io/blog/2018/08/23/super-tiny-interpreter"><link data-rh="true" rel="alternate" href="https://akatquas.github.io/blog/2018/08/23/super-tiny-interpreter" hreflang="en"><link data-rh="true" rel="alternate" href="https://akatquas.github.io/blog/2018/08/23/super-tiny-interpreter" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="AkatQuas&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="AkatQuas&#39;s blog Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d30c7ca7.css">
<link rel="preload" href="/assets/js/runtime~main.5d758bff.js" as="script">
<link rel="preload" href="/assets/js/main.6f4b5c91.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="AkatQuas" class="themedImage_ToTc themedImage--light_HNdA"><img src="/images/logo.svg" alt="AkatQuas" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">AkatQuas 🔭</b></a><a class="navbar__item navbar__link" href="/docs/about">Topic</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://akatquas.github.io/dateless/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Dateless<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/AkatQuas/AkatQuas.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/11/23/excerpt-on-unit-test">单元测试的实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/11/design-a-cli-tool">设计一个 CLI 工具</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/05/30/architecture-design-imo">架构设计的一些哲学经验</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/05/09/electron-application-architecture">Electron 应用的理想架构设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/04/type-vs-interface">Type vs Interface</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Super tiny interpreter in JavaScript</h1><div class="container_mt6G margin-vert--md"><time datetime="2018-08-23T00:00:00.000Z" itemprop="datePublished">August 23, 2018</time> · <!-- -->7 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Today we&#x27;re going to write a compiler together. But not just any compiler... A super duper teeny tiny compiler!</p><p>We&#x27;re going to compile some lisp-like function calls into some C-like function calls.</p><p>If you are not familiar with one or the other. I&#x27;ll just give you a quick intro.</p><p>If we had two functions <code>add</code> and <code>subtract</code> they would be written like this:</p><table><thead><tr><th align="left"></th><th align="left">LISP</th><th align="left">C</th></tr></thead><tbody><tr><td align="left">2 + 2</td><td align="left">(add 2 2)</td><td align="left">add(2, 2)</td></tr><tr><td align="left">4 - 2</td><td align="left">(subtract 4 2)</td><td align="left">subtract(4, 2)</td></tr><tr><td align="left">2 + (4 - 2)</td><td align="left">(add 2 (subtract 4 2))</td><td align="left">add(2, subtract(4, 2))</td></tr></tbody></table><p>Easy peezy right?</p><p>Well good, because this is exactly what we are going to compile. While this is neither a complete LISP or C syntax, it will be enough of the syntax to demonstrate many of the major pieces of a modern compiler.</p><p>Most compilers break down into three primary stages: Parsing, Transformation, and Code Generation</p><ol><li><p>Parsing: is taking raw code and turning it into a more abstract representation of the code.</p></li><li><p>Transformation: takes this abstract representation and manipulates to do whatever the compiler wants it to.</p></li><li><p>Code Generation: takes the transformed representation of the code and turns it into new code.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parsing">Parsing<a class="hash-link" href="#parsing" title="Direct link to heading">​</a></h2><p><a target="_blank" href="/assets/files/tokenizer-1475655a1e6c1ea0e10c1dae40209a82.js">tokenizer.js</a></p><p><a target="_blank" href="/assets/files/parser-24e2933b6e000ca5af98a1b190ba5593.js">parser.js</a></p><p>Parsing typically gets broken down into two phases: Lexical Analysis and Syntactic Analysis.</p><ol><li><p>Lexical Analysis takes the raw code and splits it apart into these things called tokens by a thing called a tokenizer (or lexer).</p><p>Tokens are an array of tiny little objects that describe an isolated piece of the syntax. They could be numbers, labels, punctuation, operators, whatever.</p></li><li><p>Syntactic Analysis takes the tokens and reformats them into a representation that describes each part of the syntax and their relation to one another. This is known as an intermediate representation or Abstract Syntax Tree.</p><p>An Abstract Syntax Tree, or AST for short, is a deeply nested object that represents code in a way that is both easy to work with and tells us a lot of information.</p></li></ol><p>For the following syntax:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">(add 2 (subtract 4 2))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Tokens might look something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;paren&#x27;,  value: &#x27;(&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;name&#x27;,   value: &#x27;add&#x27;      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;number&#x27;, value: &#x27;2&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;paren&#x27;,  value: &#x27;(&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;name&#x27;,   value: &#x27;subtract&#x27; },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;number&#x27;, value: &#x27;4&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;number&#x27;, value: &#x27;2&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;paren&#x27;,  value: &#x27;)&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { type: &#x27;paren&#x27;,  value: &#x27;)&#x27;        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>An Abstract Syntax Tree (AST) might look like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    type: &#x27;Program&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    body: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        type: &#x27;CallExpression&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &#x27;add&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        params: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            value: &#x27;2&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }, {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            type: &#x27;CallExpression&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            name: &#x27;subtract&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            params: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                value: &#x27;4&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }, {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                value: &#x27;2&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transformation">Transformation<a class="hash-link" href="#transformation" title="Direct link to heading">​</a></h2><p><a target="_blank" href="/assets/files/transformer-1c203ac8cfc93e3e0580b7fa5debfbe2.js">transformer.js</a></p><p>The next type of stage for a compiler is transformation. Again, this just takes the AST from the last step and makes changes to it. It can manipulate the AST in the same language, or it can translate it into an entirely new language.</p><p>Let’s look at how we would transform an AST.</p><p>You might notice that our AST has elements within it that look very similar.</p><p>There are these objects with a type property. Each of these are known as an AST Node. These nodes have defined properties on them that describe one isolated part of the tree.</p><p>We can have a node for a &quot;NumberLiteral&quot;:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: &#x27;2&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or maybe a node for a &quot;CallExpression&quot;:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    type: &#x27;CallExpression&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &#x27;subtract&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    params: [...nested nodes go here...],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When transforming the AST we can manipulate nodes by adding/removing/replacing properties, we can add new nodes, remove nodes, or we could leave the existing AST alone and create an entirely new one based on it.</p><p>Since we’re targeting a new language, we’re going to focus on creating an entirely new AST that is specific to the target language.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="traversal">Traversal<a class="hash-link" href="#traversal" title="Direct link to heading">​</a></h2><p>In order to navigate through all of these nodes, we need to be able to traverse through them. This traversal process goes to each node in the AST depth-first.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    type: &#x27;Program&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    body: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        type: &#x27;CallExpression&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &#x27;add&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        params: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            value: &#x27;2&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }, {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            type: &#x27;CallExpression&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            name: &#x27;subtract&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            params: [{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                value: &#x27;4&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }, {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                type: &#x27;NumberLiteral&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                value: &#x27;2&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So for the above AST we would go:</p><ol><li><p>Program - Starting at the top-level of the AST</p></li><li><p>CallExpression (add) - Moving to the first element of the Program&#x27;s body</p></li><li><p>NumberLiteral (2) - Moving to the first element of CallExpression&#x27;s params</p></li><li><p>CallExpression (subtract) - Moving to the second element of CallExpression&#x27;s params</p></li><li><p>NumberLiteral (4) - Moving to the first element of CallExpression&#x27;s params</p></li><li><p>NumberLiteral (2) - Moving to the second element of CallExpression&#x27;s params</p></li></ol><p>If we were manipulating this AST directly, instead of creating a separate AST, we would likely introduce all sorts of abstractions here. But just visiting each node in the tree is enough for what we&#x27;re trying to do.</p><p>The reason I use the word &quot;visiting&quot; is because there is this pattern of how to represent operations on elements of an object structure.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="visitors">Visitors<a class="hash-link" href="#visitors" title="Direct link to heading">​</a></h2><p>The basic idea here is that we are going to create a “visitor” object that has methods that will accept different node types.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">var visitor = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    NumberLiteral() {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CallExpression() {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When we traverse our AST, we will call the methods on this visitor whenever we &quot;enter&quot; a node of a matching type.</p><p>In order to make this useful we will also pass the node and a reference to the parent node.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">var visitor = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    NumberLiteral(node, parent) {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CallExpression(node, parent) {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, there also exists the possibility of calling things on &quot;exit&quot;. Imagine our tree structure from before in list form:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">- Program</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - CallExpression</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - NumberLiteral</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - CallExpression</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - NumberLiteral</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - NumberLiteral</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we traverse down, we&#x27;re going to reach branches with dead ends. As we finish each branch of the tree we &quot;exit&quot; it. So going down the tree we &quot;enter&quot; each node, and going back up we &quot;exit&quot;.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-&gt; Program (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -&gt; CallExpression (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -&gt; Number Literal (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;- Number Literal (exit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -&gt; Call Expression (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -&gt; Number Literal (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;- Number Literal (exit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -&gt; Number Literal (enter)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;- Number Literal (exit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;- CallExpression (exit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;- CallExpression (exit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;- Program (exit)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to support that, the final form of our visitor will look like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">var visitor = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    NumberLiteral: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        enter(node, parent) {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit(node, parent) {},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-generation">Code Generation<a class="hash-link" href="#code-generation" title="Direct link to heading">​</a></h2><p><a target="_blank" href="/assets/files/generator-84354561e6fc6f774bdd4ec5c40fd6a6.js">generator.js</a></p><p>The final phase of a compiler is code generation. Sometimes compilers will do things that overlap with transformation, but for the most part code generation just means take our AST and stringify code back out.</p><p>Code generators work in different ways, some compilers will reuse the tokens from earlier, others will have created a separate representation of the code so that they can print node linearly, but from what I can tell most will use the same AST we just created, which is what we’re going to focus on.</p><p>Effectively our code generator will know how to “print” all the different node types of the AST, and it will recursively call itself to print nested nodes until everything print into one long string of code.</p><p>The complete <a target="_blank" href="/assets/files/interpreter-183e6088c69150c3d8629a67727305ed.js">interpreter.js</a>.</p><p><a target="_blank" href="/assets/files/test-9718dd88dacb6cc7b27d5e0f5b175a2d.js">test.js</a> to test these functions.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/javascript">javascript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/interpreter">interpreter</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2018/09/13/web-server-with-tcp"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Web server running over TCP</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2018/08/15/react-stores"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">React 状态库的使用</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#parsing" class="table-of-contents__link toc-highlight">Parsing</a></li><li><a href="#transformation" class="table-of-contents__link toc-highlight">Transformation</a></li><li><a href="#traversal" class="table-of-contents__link toc-highlight">Traversal</a></li><li><a href="#visitors" class="table-of-contents__link toc-highlight">Visitors</a></li><li><a href="#code-generation" class="table-of-contents__link toc-highlight">Code Generation</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas/kiddo-plays" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kiddo plays<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/AkatQuas/nprogresse" target="_blank" rel="noopener noreferrer" class="footer__link-item">NProgressE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AkatQuas" target="_blank" rel="noopener noreferrer" class="footer__link-item">Who would it be?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 AkatQuas. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5d758bff.js"></script>
<script src="/assets/js/main.6f4b5c91.js"></script>
</body>
</html>